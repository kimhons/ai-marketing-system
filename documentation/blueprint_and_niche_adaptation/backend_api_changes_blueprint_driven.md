# Backend API Changes for Blueprint-Driven AI Marketing System

This document outlines the necessary changes to the backend API to support the enhanced, blueprint-driven AI Marketing System. This includes integration of the detailed intake form, the AI Adaptation Agent, unique business blueprint generation, and personalized campaign management, as detailed in the updated `campaign_ui_design.md` and `ai_agent_architecture.md`.

## 1. Core Data Model Changes (Firestore)

The data models in Firebase Firestore will be significantly updated to support the new architecture.

### 1.1. User/Business Profile Document (`users/{userId}` or `businesses/{businessId}`)

*   **`intakeFormAnswers`**: (Map/Object) Stores the complete, structured responses from the detailed intake form.
*   **`businessBlueprintId`**: (String) Reference to the unique business blueprint document for this user/business.
*   **`blueprintStatus`**: (String) e.g., "pending_intake", "generating_blueprint", "blueprint_ready", "blueprint_active", "blueprint_update_pending".

### 1.2. Business Blueprint Document (`businessBlueprints/{blueprintId}`)

*   **`userId` / `businessId`**: (String) Reference back to the user/business.
*   **`generatedAt`**: (Timestamp) When the blueprint was created/last updated.
*   **`aiAgentVersion`**: (String) Version of the AI Adaptation Agent that generated this blueprint.
*   **`intakeSummary`**: (Map/Object) AI-processed summary of key intake form data.
*   **`definedPersonas`**: (Array of Maps/Objects) Detailed target audience personas generated by AI.
*   **`coreMarketingObjectives`**: (Array of Maps/Objects) SMART objectives with defined KPIs.
*   **`recommendedStrategies`**: (Array of Maps/Objects) Detailed strategies, including rationale, channel recommendations, content themes, and suggested campaign outlines.
*   **`suggestedWorkflows`**: (Array of Maps/Objects) Initial marketing automation suggestions.
*   **`budgetAllocationGuidance`**: (Map/Object, Optional) AI-suggested budget breakdown.
*   **`userFeedback`**: (Array of Maps/Objects, Optional) Stores user feedback on blueprint elements for iterative refinement.

### 1.3. Campaign Data Model (`campaigns/{campaignId}` - Revisions)

*   **`blueprintStrategyAlignment`**: (String/Map) Links the campaign to a specific strategy or objective within the business blueprint.
*   **`blueprintDrivenConfiguration`**: (Map/Object) Stores how the campaign settings (audience, budget, content themes) were derived or influenced by the blueprint.
*   KPIs and goals will be more directly tied to those defined in the blueprint.

## 2. New API Endpoints

### 2.1. Intake Form Management

*   **`POST /intake`**
    *   **Purpose:** Submit completed intake form data.
    *   **Request Body:** JSON object containing all answers from `intake_form_questions.md`.
    *   **Logic:** Validates data, stores it in `users/{userId}/intakeFormAnswers`, updates `users/{userId}/blueprintStatus` to "generating_blueprint", and triggers the AI Adaptation Agent to start blueprint generation (likely asynchronously).
    *   **Response:** Confirmation message, potentially including an estimated time for blueprint readiness.
*   **`GET /intake`**
    *   **Purpose:** Retrieve previously submitted intake form data for review or update.
    *   **Response:** The user's `intakeFormAnswers`.
*   **`PUT /intake`**
    *   **Purpose:** Update existing intake form data.
    *   **Logic:** Updates `intakeFormAnswers`, potentially triggers a blueprint regeneration or update process.
    *   **Response:** Confirmation.

### 2.2. Business Blueprint Management

*   **`GET /blueprints/mine`**
    *   **Purpose:** Retrieve the current user's active business blueprint.
    *   **Logic:** Fetches the blueprint referenced in `users/{userId}/businessBlueprintId`.
    *   **Response:** The complete business blueprint document.
*   **`POST /blueprints/{blueprintId}/feedback`**
    *   **Purpose:** Allow users to provide feedback on specific elements of their blueprint.
    *   **Request Body:** `{ "elementId": "strategy_001", "feedbackText": "This doesn't quite fit my current capacity.", "suggestedChange": "Prioritize X instead." }`
    *   **Logic:** Stores feedback in `businessBlueprints/{blueprintId}/userFeedback`. May trigger an AI review or refinement process for the blueprint.
    *   **Response:** Confirmation.

### 2.3. AI Adaptation Agent Interaction (Internal or Secured Endpoints)

*   **`POST /ai/generate-blueprint` (Likely an internal trigger or secured endpoint)**
    *   **Purpose:** Initiates the AI blueprint generation process for a user after intake form submission.
    *   **Request Body:** `{ "userId": "user_abc_123" }`
    *   **Logic:** Orchestrates the AI Adaptation Agent's modules (data preprocessing, NLP, pattern recognition, knowledge base querying, strategy formulation) as defined in `ai_agent_architecture.md`. Saves the generated blueprint and updates user's `blueprintStatus`.
    *   **Response:** Asynchronous task ID or internal confirmation.
*   **`POST /ai/refine-blueprint` (Internal or Secured)**
    *   **Purpose:** Triggers AI to refine a blueprint based on user feedback or new data.
    *   **Request Body:** `{ "blueprintId": "bp_xyz_789", "feedbackData": { ... } }`
    *   **Response:** Asynchronous task ID or internal confirmation.

## 3. Modified API Endpoints

### 3.1. Campaign Management (`/campaigns`)

*   **`POST /campaigns` (Create Campaign)**
    *   **Request Body:** Will now include fields like `blueprintStrategyId` (linking to a strategy in the user's blueprint). The API will expect less manual input for things like audience or objectives if they are derived from the blueprint.
    *   **Logic:** Validates against the user's blueprint. Campaign settings are heavily influenced or pre-filled based on the selected blueprint strategy.
*   **`PUT /campaigns/{campaignId}` (Update Campaign)**
    *   Similar blueprint-aware logic.
*   **`GET /campaigns` and `GET /campaigns/{campaignId}`**
    *   **Response Body:** Will include `blueprintStrategyAlignment` and other blueprint-derived context for each campaign.

### 3.2. User Profile (`/users/{userId}` - if applicable)

*   The user profile endpoint might now also return `blueprintStatus` and a summary or link to their blueprint.

## 4. Backend Logic for AI Integration & Asynchronous Tasks

*   **AI Agent Service:** A dedicated service/module within the backend will encapsulate the logic of the AI Adaptation Agent.
*   **Asynchronous Processing:** Blueprint generation and potentially complex AI-driven campaign suggestions will be handled asynchronously (e.g., using Cloud Functions, Cloud Run, or Celery with a task queue) to ensure responsive APIs. The `blueprintStatus` field will track progress.
*   **Knowledge Base Management:** Mechanisms for updating and managing the AI's knowledge base of marketing strategies and best practices.

## 5. Authentication and Authorization

*   All endpoints remain protected by Firebase Authentication.
*   Strict authorization rules to ensure users can only access/manage their own intake data, blueprints, and campaigns.

These API changes are designed to create a robust backend that powers a highly personalized, autonomous, and adaptable AI Marketing System, centered around the unique business blueprint generated for each user.
